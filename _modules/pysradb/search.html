
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-CKQZFCEENZ"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            
            gtag('config', 'G-CKQZFCEENZ');
            
        </script>
    
    <title>pysradb.search &#8212; pysradb 1.0.1 documentation</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/tabs.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-CKQZFCEENZ"></script>
<script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-CKQZFCEENZ');
                </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/pysradb_v3.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../installation.html">
  Installation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../quickstart.html">
  Quickstart
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../cmdline.html">
  CLI
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../python-api-usage.html">
  Python API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../case_studies.html">
  Case Studies
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../commands.html">
  API Documentation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../contributing.html">
  Contributing
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../authors.html">
  Credits
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../history.html">
  History
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../modules.html">
  pysradb
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/saketkc/pysradb" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for pysradb.search</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;This file contains the search classes for the search feature.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">Et</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">JSONDecodeError</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">IncorrectFieldException</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">MissingQueryException</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">requests_3_retries</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">scientific_name_to_taxid</span>

<span class="n">SEARCH_REQUEST_TIMEOUT</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">SRA_SEARCH_GROUP_SIZE</span> <span class="o">=</span> <span class="mi">300</span>


<div class="viewcode-block" id="QuerySearch"><a class="viewcode-back" href="../../pysradb.html#pysradb.search.QuerySearch">[docs]</a><span class="k">class</span> <span class="nc">QuerySearch</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This is the base class for the search feature.</span>

<span class="sd">    This class takes as input the user&#39;s search query, which has been</span>
<span class="sd">    tokenized by the ArgParser. The query will be sent to either SRA or ENA</span>
<span class="sd">    depending on the user&#39;s input, and the results will be returned as a</span>
<span class="sd">    pandas dataframe.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    self.df: Pandas DataFrame</span>
<span class="sd">        The search result belonging to this search instance</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    verbosity : integer</span>
<span class="sd">        The level of details of the search result.</span>
<span class="sd">    return_max : int</span>
<span class="sd">        The maximum number of entries to be returned.</span>
<span class="sd">    query : str</span>
<span class="sd">        The main query string.</span>
<span class="sd">    accession : str</span>
<span class="sd">        A relevant study / experiment / sample / run accession number.</span>
<span class="sd">    organism  : str</span>
<span class="sd">        Scientific name of the sample organism</span>
<span class="sd">    layout : str</span>
<span class="sd">        Library layout. Possible inputs: single, paired</span>
<span class="sd">    mbases : int</span>
<span class="sd">        Size of the sample of interest rounded to the nearest megabase.</span>
<span class="sd">    publication_date : str</span>
<span class="sd">        The publication date of the run in the format dd-mm-yyyy. If a</span>
<span class="sd">        date range is desired, input should be in the format of</span>
<span class="sd">        dd-mm-yyyy:dd-mm-yyyy</span>
<span class="sd">    platform : str</span>
<span class="sd">        Sequencing platform used for the run. Some possible inputs include:</span>
<span class="sd">        illumina, ion torrent, oxford nanopore</span>
<span class="sd">    selection : str</span>
<span class="sd">        Library selection. Some possible inputs: cdna, chip, dnase, pcr</span>
<span class="sd">    source : str</span>
<span class="sd">        Library source. Some possible inputs: genomic, metagenomic,</span>
<span class="sd">        transcriptomic</span>
<span class="sd">    strategy : str</span>
<span class="sd">        Library Preparation strategy. Some possible inputs: wgs, amplicon,</span>
<span class="sd">        rna seq</span>
<span class="sd">    title : str</span>
<span class="sd">        Title of the experiment associated with the run</span>
<span class="sd">    suppress_validation: bool</span>
<span class="sd">        Defaults to False. If this is set to True, the user input format</span>
<span class="sd">        checks will be skipped.</span>
<span class="sd">        Setting this to True may cause the program to behave in unexpected</span>
<span class="sd">        ways, but allows the user to search queries that does not pass the</span>
<span class="sd">        format check.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    get_df()</span>
<span class="sd">        Returns the dataframe storing this search result.</span>

<span class="sd">    search()</span>
<span class="sd">        Executes the search.</span>

<span class="sd">    show_result_statistics()</span>
<span class="sd">        Shows summary information about search results.</span>

<span class="sd">    visualise_results()</span>
<span class="sd">        Generate graphs that visualise the search results.</span>

<span class="sd">    get_plot_objects():</span>
<span class="sd">        Get the plot objects for plots generated.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">return_max</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">accession</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">organism</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">layout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mbases</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">publication_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">platform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">selection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">strategy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">suppress_validation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">int_verbosity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">verbosity</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">int_verbosity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">IncorrectFieldException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Incorrect verbosity format: </span><span class="si">{verbosity}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Verbosity must be an integer between 0 to 3 inclusive.&quot;</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">int_return_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">return_max</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">int_return_max</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">IncorrectFieldException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Incorrect return_max format: </span><span class="si">{return_max}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;return_max must be a positive integer.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="n">int_verbosity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_max</span> <span class="o">=</span> <span class="n">int_return_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
            <span class="s2">&quot;accession&quot;</span><span class="p">:</span> <span class="n">accession</span><span class="p">,</span>
            <span class="s2">&quot;organism&quot;</span><span class="p">:</span> <span class="n">organism</span><span class="p">,</span>
            <span class="s2">&quot;layout&quot;</span><span class="p">:</span> <span class="n">layout</span><span class="p">,</span>
            <span class="s2">&quot;mbases&quot;</span><span class="p">:</span> <span class="n">mbases</span><span class="p">,</span>
            <span class="s2">&quot;publication_date&quot;</span><span class="p">:</span> <span class="n">publication_date</span><span class="p">,</span>
            <span class="s2">&quot;platform&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="p">,</span>
            <span class="s2">&quot;selection&quot;</span><span class="p">:</span> <span class="n">selection</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span>
            <span class="s2">&quot;strategy&quot;</span><span class="p">:</span> <span class="n">strategy</span><span class="p">,</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="c1"># Verify that not all query fields are empty</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">MissingQueryException</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_validation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_fields</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;study&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;experiment&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;run&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sample&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Date range&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Organisms&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Library strategy&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Library source&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Library selection&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Library layout&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Platform&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;count_mean&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;count_median&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;count_stdev&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_objects</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_input_multi_regex_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regex_matcher</span><span class="p">,</span> <span class="n">input_query</span><span class="p">,</span> <span class="n">error_message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks if the user input match exactly 1 of the possible regex.</span>

<span class="sd">        This is a helper method for _validate_fields. It takes as input a</span>
<span class="sd">        dictionary of regex expression : accepted string by API pairs, and</span>
<span class="sd">        an input string, and verifies that the input string matches exactly</span>
<span class="sd">        one of the regex expressions.</span>
<span class="sd">        Matching multiple expressions indicates the input string is</span>
<span class="sd">        ambiguous, while matching none of the expressions suggests the</span>
<span class="sd">        input will likely produce no results or an error.</span>
<span class="sd">        Once matched, this method formats the user input so that it</span>
<span class="sd">        can be accepted by the API to be queried, as ENA especially expect</span>
<span class="sd">        case-sensitive exact matches for search queries.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        regex_matcher : dict</span>
<span class="sd">            dictionary of regex expression : accepted string by API pairs.</span>
<span class="sd">        input_query : str</span>
<span class="sd">            input string for a particular query field.</span>
<span class="sd">        error_message : str</span>
<span class="sd">            error message to be shown if input_query does not match any of</span>
<span class="sd">            the regex expressions in regex_matcher.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            tuple pair of (input_query, message).</span>
<span class="sd">            message is &quot;&quot; if no format error has been identified, error</span>
<span class="sd">            message otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matched_strings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">regex_expression</span> <span class="ow">in</span> <span class="n">regex_matcher</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex_expression</span><span class="p">,</span> <span class="n">input_query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
                <span class="n">matched_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">regex_matcher</span><span class="p">[</span><span class="n">regex_expression</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">matched_strings</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">input_query</span><span class="p">,</span> <span class="n">error_message</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_strings</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">matched_strings</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Multiple potential matches have been identified for </span><span class="si">{input_query}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{matched_strings}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Please check your input.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">input_query</span><span class="p">,</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">_validate_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verifies that user input format is correct.</span>

<span class="sd">        This helper function tries to match the input query strings from</span>
<span class="sd">        the user to the exact string that is accepted by both SRA and ENA</span>

<span class="sd">        Note: as of the implementation of this method, ENA does not have</span>
<span class="sd">        a documentation page listing the accepted values for query</span>
<span class="sd">        parameters. The list of parameters below were collected from ENA&#39;s</span>
<span class="sd">        advanced search page: https://www.ebi.ac.uk/ena/browser/advanced-search</span>

<span class="sd">        Updating new values:</span>
<span class="sd">        If any new values are accepted by ENA, it should appear under</span>
<span class="sd">        the corresponding parameter in the page. To update this method,</span>
<span class="sd">        think of a regex that captures what the user may type for the new</span>
<span class="sd">        value, and include it in the respective xxx_matcher dictionary</span>
<span class="sd">        below as a regex:value key value pair.</span>

<span class="sd">        Eg: if a new sequencing platform, Pokemon, is added to ENA,</span>
<span class="sd">        navigate to &quot;Instrument Platform&quot; parameter on ENA&#39;s advanced</span>
<span class="sd">        search page and copy the corresponding phrase (eg &quot;poKe_Mon&quot;).</span>
<span class="sd">        Then add the key value pair &quot;.*poke.*&quot;: &quot;poKe_Mon&quot; to</span>
<span class="sd">        platform_matcher below.</span>

<span class="sd">        Unlike SRA, ENA requires supplied param values to be exact match</span>
<span class="sd">        to filter accordingly (eg &quot;cDNA_oligo_dT&quot;), which motivated this</span>
<span class="sd">        feature.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        IncorrectFieldException</span>
<span class="sd">            If the input to any query field is in the wrong format</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># verify layout</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;layout&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;layout&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;SINGLE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PAIRED&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Incorrect layout field format: </span><span class="si">{self.fields[&#39;layout&#39;]}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;--layout must be either SINGLE or PAIRED</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># verify mbases</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;mbases&quot;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;mbases&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;mbases&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;mbases&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Incorrect mbases format: </span><span class="si">{self.fields[&#39;mbases&#39;]}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;--mbases must be a positive integer</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="c1"># verify publication_date</span>
        <span class="n">date_regex</span> <span class="o">=</span> <span class="s2">&quot;(0[1-9]|[12][0-9]|3[01])-(0[1-9]|1[012])-(19|20)[0-9]</span><span class="si">{2}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;publication_date&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;^</span><span class="si">{date_regex}</span><span class="s2">(:</span><span class="si">{date_regex}</span><span class="s2">)?$&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;publication_date&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Incorrect publication date format: </span><span class="si">{self.fields[&#39;publication_date&#39;]}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Expected --publication-date format: dd-mm-yyyy or dd-mm-yyyy:dd-mm-yyyy, between 1900-2099</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># verify platform</span>
        <span class="n">platform_matcher</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;.*oxford.*|.*nanopore.*&quot;</span><span class="p">:</span> <span class="s2">&quot;OXFORD_NANOPORE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*illumina.*&quot;</span><span class="p">:</span> <span class="s2">&quot;ILLUMINA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*ion.*torrent.*&quot;</span><span class="p">:</span> <span class="s2">&quot;ION_TORRENT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*capillary.*&quot;</span><span class="p">:</span> <span class="s2">&quot;CAPILLARY&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*pacbio.*|.*smrt.*&quot;</span><span class="p">:</span> <span class="s2">&quot;PACBIO_SMRT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*abi.*solid.*&quot;</span><span class="p">:</span> <span class="s2">&quot;ABI_SOLID&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*bgi.*&quot;</span><span class="p">:</span> <span class="s2">&quot;BGISEQ&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*454.*&quot;</span><span class="p">:</span> <span class="s2">&quot;LS454&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*complete.*genomics.*&quot;</span><span class="p">:</span> <span class="s2">&quot;COMPLETE_GENOMICS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*helicos.*&quot;</span><span class="p">:</span> <span class="s2">&quot;HELICOS&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Incorrect platform: </span><span class="si">{self.fields[&#39;platform&#39;]}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;--platform must be one of the following: </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;OXFORD_NANOPORE, ILLUMINA, ION_TORRENT, </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;CAPILLARY, PACBIO_SMRT, ABI_SOLID, </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;BGISEQ, LS454, COMPLETE_GENOMICS, HELICOS</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_multi_regex_checker</span><span class="p">(</span>
                <span class="n">platform_matcher</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">],</span> <span class="n">error_message</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># verify selection</span>
        <span class="n">selection_matcher</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;.*methylcytidine.*&quot;</span><span class="p">:</span> <span class="s2">&quot;5-methylcytidine antibody&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*cage.*&quot;</span><span class="p">:</span> <span class="s2">&quot;CAGE&quot;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s2">&quot;.*chip\s*$&quot;</span><span class="p">:</span> <span class="s2">&quot;ChIP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*chip.*seq.*&quot;</span><span class="p">:</span> <span class="s2">&quot;ChIP-Seq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*dnase.*&quot;</span><span class="p">:</span> <span class="s2">&quot;DNase&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*hmpr.*&quot;</span><span class="p">:</span> <span class="s2">&quot;HMPR&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*hybrid.*&quot;</span><span class="p">:</span> <span class="s2">&quot;Hybrid Selection&quot;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s2">&quot;.*inverse.*rrna\s*$&quot;</span><span class="p">:</span> <span class="s2">&quot;Inverse rRNA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*inverse.*rrna.*selection.*&quot;</span><span class="p">:</span> <span class="s2">&quot;Inverse rRNA selection&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*mbd2.*protein.*methyl.*cpg.*binding.*domain.*&quot;</span><span class="p">:</span> <span class="s2">&quot;MBD2 protein methyl-CpG binding domain&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*mda.*&quot;</span><span class="p">:</span> <span class="s2">&quot;MDA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*mf.*&quot;</span><span class="p">:</span> <span class="s2">&quot;MF&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*mnase.*&quot;</span><span class="p">:</span> <span class="s2">&quot;MNase&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*msll.*&quot;</span><span class="p">:</span> <span class="s2">&quot;MSLL&quot;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s2">&quot;^\s*oligo.*dt.*&quot;</span><span class="p">:</span> <span class="s2">&quot;Oligo-dT&quot;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s2">&quot;^\s*pcr\s*$&quot;</span><span class="p">:</span> <span class="s2">&quot;PCR&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*poly[ -_]*a.*&quot;</span><span class="p">:</span> <span class="s2">&quot;PolyA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*race.*&quot;</span><span class="p">:</span> <span class="s2">&quot;RACE&quot;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s2">&quot;.*random\s*$&quot;</span><span class="p">:</span> <span class="s2">&quot;RANDOM&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*random.*pcr.*&quot;</span><span class="p">:</span> <span class="s2">&quot;RANDOM PCR&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*rt[ -_]*pcr.*&quot;</span><span class="p">:</span> <span class="s2">&quot;RT-PCR&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*reduced.*representation.*&quot;</span><span class="p">:</span> <span class="s2">&quot;Reduced Representation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*restriction.*digest.*&quot;</span><span class="p">:</span> <span class="s2">&quot;Restriction Digest&quot;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s2">&quot;.*cdna\s*$&quot;</span><span class="p">:</span> <span class="s2">&quot;cDNA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*cdna.*oligo.*dt&quot;</span><span class="p">:</span> <span class="s2">&quot;cDNA_oligo_dT.*&quot;</span><span class="p">,</span>  <span class="c1"># ENA only</span>
            <span class="s2">&quot;.*cdna.*random.*priming&quot;</span><span class="p">:</span> <span class="s2">&quot;cDNA_randomPriming.*&quot;</span><span class="p">,</span>  <span class="c1"># ENA only</span>
            <span class="s2">&quot;.*other.*&quot;</span><span class="p">:</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*padlock.*probes.*capture.*method.*&quot;</span><span class="p">:</span> <span class="s2">&quot;padlock probes capture method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*repeat.*fractionation.*&quot;</span><span class="p">:</span> <span class="s2">&quot;repeat fractionation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*size.*fractionation.*&quot;</span><span class="p">:</span> <span class="s2">&quot;size fractionation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*unspecified.*&quot;</span><span class="p">:</span> <span class="s2">&quot;unspecified&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;selection&quot;</span><span class="p">]:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Incorrect selection: </span><span class="si">{self.fields[&#39;selection&#39;]}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;--selection must be one of the following: </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;5-methylcytidine antibody, CAGE, ChIP, ChIP-Seq, DNase, HMPR, Hybrid Selection,  </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Inverse rRNA, Inverse rRNA selection, MBD2 protein methyl-CpG binding domain, </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;MDA, MF, MNase, MSLL, Oligo-dT, PCR, PolyA, RACE, RANDOM, RANDOM PCR, RT-PCR,  </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Reduced Representation, Restriction Digest, cDNA, cDNA_oligo_dT, cDNA_randomPriming </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;other, padlock probes capture method, repeat fractionation, size fractionation, </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;unspecified</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_multi_regex_checker</span><span class="p">(</span>
                <span class="n">selection_matcher</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;selection&quot;</span><span class="p">],</span> <span class="n">error_message</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;selection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># verify source</span>
        <span class="n">source_matcher</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">r</span><span class="s2">&quot;^\s*genomic\s*$&quot;</span><span class="p">:</span> <span class="s2">&quot;GENOMIC&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*genomic.*single.*cell.*&quot;</span><span class="p">:</span> <span class="s2">&quot;GENOMIC SINGLE CELL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*metagenomic.*&quot;</span><span class="p">:</span> <span class="s2">&quot;METAGENOMIC&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*metatranscriptomic.*&quot;</span><span class="p">:</span> <span class="s2">&quot;METATRANSCRIPTOMIC&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*other.*&quot;</span><span class="p">:</span> <span class="s2">&quot;OTHER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*synthetic.*&quot;</span><span class="p">:</span> <span class="s2">&quot;SYNTHETIC&quot;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s2">&quot;^\s*transcriptomic\s*$&quot;</span><span class="p">:</span> <span class="s2">&quot;TRANSCRIPTOMIC&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*transcriptomic.*single.*cell.*&quot;</span><span class="p">:</span> <span class="s2">&quot;TRANSCRIPTOMIC SINGLE CELL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*viral.*rna.*&quot;</span><span class="p">:</span> <span class="s2">&quot;VIRAL RNA&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Incorrect source: </span><span class="si">{self.fields[&#39;source&#39;]}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;--source must be one of the following: </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;GENOMIC, GENOMIC SINGLE CELL, METAGENOMIC,  </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;METATRANSCRIPTOMIC, OTHER, SYNTHETIC, </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;TRANSCRIPTOMIC, TRANSCRIPTOMIC SINGLE CELL, VIRAL RNA</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_multi_regex_checker</span><span class="p">(</span>
                <span class="n">source_matcher</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span> <span class="n">error_message</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># verify strategy</span>
        <span class="n">strategy_matcher</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;.*amplicon.*&quot;</span><span class="p">:</span> <span class="s2">&quot;AMPLICON&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*atac.*&quot;</span><span class="p">:</span> <span class="s2">&quot;ATAC-seq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*bisulfite.*&quot;</span><span class="p">:</span> <span class="s2">&quot;Bisulfite-Seq&quot;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s2">&quot;^\s*clone\s*$&quot;</span><span class="p">:</span> <span class="s2">&quot;CLONE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*cloneend.*&quot;</span><span class="p">:</span> <span class="s2">&quot;CLONEEND&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*cts.*&quot;</span><span class="p">:</span> <span class="s2">&quot;CTS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*chia.*|.*pet.*&quot;</span><span class="p">:</span> <span class="s2">&quot;ChIA-PET&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*chip.*seq.*&quot;</span><span class="p">:</span> <span class="s2">&quot;ChIP-Seq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*dnase.*|.*hypersensitivity.*&quot;</span><span class="p">:</span> <span class="s2">&quot;DNase-Hypersensitivity&quot;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s2">&quot;^\s*est\s*$&quot;</span><span class="p">:</span> <span class="s2">&quot;EST&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*faire.*&quot;</span><span class="p">:</span> <span class="s2">&quot;FAIRE-seq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*finishing.*&quot;</span><span class="p">:</span> <span class="s2">&quot;FINISHING&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*fl.*cdna.*&quot;</span><span class="p">:</span> <span class="s2">&quot;FL-cDNA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*hi.*c.*&quot;</span><span class="p">:</span> <span class="s2">&quot;Hi-C&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*mbd.*&quot;</span><span class="p">:</span> <span class="s2">&quot;MBD-Seq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*mnase.*&quot;</span><span class="p">:</span> <span class="s2">&quot;MNase-Seq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*mre.*&quot;</span><span class="p">:</span> <span class="s2">&quot;MRE-Seq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*medip.*&quot;</span><span class="p">:</span> <span class="s2">&quot;MeDIP-Seq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*other.*&quot;</span><span class="p">:</span> <span class="s2">&quot;OTHER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*poolclone.*&quot;</span><span class="p">:</span> <span class="s2">&quot;POOLCLONE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*rad.*&quot;</span><span class="p">:</span> <span class="s2">&quot;RAD-Seq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*rip.*&quot;</span><span class="p">:</span> <span class="s2">&quot;RIP-Seq&quot;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s2">&quot;^\s*rna.*seq&quot;</span><span class="p">:</span> <span class="s2">&quot;RNA-Seq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*selex.*&quot;</span><span class="p">:</span> <span class="s2">&quot;SELEX&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*synthetic.*|.*long.*read.*&quot;</span><span class="p">:</span> <span class="s2">&quot;Synthetic-Long-Read&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*targeted.*capture.*&quot;</span><span class="p">:</span> <span class="s2">&quot;Targeted-Capture&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*tethered.*chromatin.*conformation.*capture.*|.*tccc.*&quot;</span><span class="p">:</span> <span class="s2">&quot;Tethered Chromatin Conformation Capture&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*tn.*&quot;</span><span class="p">:</span> <span class="s2">&quot;Tn-Seq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*validation.*&quot;</span><span class="p">:</span> <span class="s2">&quot;VALIDATION&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*wcs.*&quot;</span><span class="p">:</span> <span class="s2">&quot;WCS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*wga.*&quot;</span><span class="p">:</span> <span class="s2">&quot;WGA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*wgs.*&quot;</span><span class="p">:</span> <span class="s2">&quot;WGS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*wxs.*&quot;</span><span class="p">:</span> <span class="s2">&quot;WXS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*mirna.*&quot;</span><span class="p">:</span> <span class="s2">&quot;miRNA-Seq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*ncrna.*&quot;</span><span class="p">:</span> <span class="s2">&quot;ncRNA-Seq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*ssrna.*&quot;</span><span class="p">:</span> <span class="s2">&quot;ssRNA-seq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.*gbs.*&quot;</span><span class="p">:</span> <span class="s2">&quot;GBS&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;strategy&quot;</span><span class="p">]:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Incorrect strategy: </span><span class="si">{self.fields[&#39;strategy&#39;]}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;--strategy must be one of the following: </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;AMPLICON, ATAC-seq, Bisulfite-Seq, CLONE, CLONEEND, CTS, ChIA-PET, ChIP-Seq, </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;DNase-Hypersensitivity, EST, FAIRE-seq, FINISHING, FL-cDNA, Hi-C, MBD-Seq, MNase-Seq,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;MRE-Seq, MeDIP-Seq, OTHER, POOLCLONE, RAD-Seq, RIP-Seq, RNA-Seq, SELEX, </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Synthetic-Long-Read, Targeted-Capture, Tethered Chromatin Conformation Capture, </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Tn-Seq, VALIDATION, WCS, WGA, WGS, WXS, miRNA-Seq, ncRNA-Seq, ssRNA-seq, GBS</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_multi_regex_checker</span><span class="p">(</span>
                <span class="n">strategy_matcher</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;strategy&quot;</span><span class="p">],</span> <span class="n">error_message</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;strategy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IncorrectFieldException</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_list_stat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stat_header</span><span class="p">):</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="n">stat_header</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{stat_header}</span><span class="s2">: </span><span class="si">{stat}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">stat_breakdown</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">stat_breakdown</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">  </span><span class="si">{key}</span><span class="s2">:  </span><span class="si">{stat[key]}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{stat_header}</span><span class="s2">: </span><span class="si">{stat_breakdown}</span><span class="se">\n</span><span class="s2">&quot;</span>

<div class="viewcode-block" id="QuerySearch.show_result_statistics"><a class="viewcode-back" href="../../pysradb.html#pysradb.search.QuerySearch.show_result_statistics">[docs]</a>    <span class="k">def</span> <span class="nf">show_result_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shows search result statistics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;No results are found for the current search query, hence no statistics can be generated.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Statistics for the search query:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;  =================================</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;  Number of unique studies: </span><span class="si">{self.stats[&#39;study&#39;]}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;  Number of unique experiments: </span><span class="si">{self.stats[&#39;experiment&#39;]}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;  Number of unique runs: </span><span class="si">{self.stats[&#39;run&#39;]}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;  Number of unique samples: </span><span class="si">{self.stats[&#39;sample&#39;]}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;  Mean base count of samples: </span><span class="si">{self.stats[&#39;count_mean&#39;]:.3f}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;  Median base count of samples: </span><span class="si">{self.stats[&#39;count_median&#39;]:.3f}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;  Sample base count standard deviation: </span><span class="si">{self.stats[&#39;count_stdev&#39;]:.3f}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Statistics with categorical breakdowns:</span>
        <span class="n">categorical_stats</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Date range&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Organisms&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Platform&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Library strategy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Library source&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Library selection&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Library layout&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">categorical_stat</span> <span class="ow">in</span> <span class="n">categorical_stats</span><span class="p">:</span>
            <span class="n">stats</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_stat</span><span class="p">(</span><span class="n">categorical_stat</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span></div>

<div class="viewcode-block" id="QuerySearch.visualise_results"><a class="viewcode-back" href="../../pysradb.html#pysradb.search.QuerySearch.visualise_results">[docs]</a>    <span class="k">def</span> <span class="nf">visualise_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">graph_types</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">,),</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">saveto</span><span class="o">=</span><span class="s2">&quot;./search_plots/&quot;</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate graphs that visualise the search results.</span>

<span class="sd">        This method will only work if the optional dependency, matplotlib,</span>
<span class="sd">        is installed in the system.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        graph_types : tuple</span>
<span class="sd">            tuple containing strings representing types of graphs to</span>
<span class="sd">            generate.</span>
<span class="sd">            Possible strings: all, daterange, organism, source, selection, platform,</span>
<span class="sd">            basecount</span>
<span class="sd">        saveto : str</span>
<span class="sd">            directory name where the generated graphs are saved.</span>

<span class="sd">        show : bool</span>
<span class="sd">            Whether plotted graphs are immediately shown.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;No results are found for the current search query, hence no graphs can be generated.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;The optional dependency, matplotlib, is not available on the system.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;matplotlib is required to generate graphs to visualise search results.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s1">&#39;You can install matplotlib by typing &quot;pip install matplotlib&quot; on the command line.</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.autolayout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">saveto</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">saveto</span><span class="p">)</span>
        <span class="n">plots</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;Base Count&quot;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s2">&quot;Publication Date&quot;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s2">&quot;Organism&quot;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s2">&quot;Library Source&quot;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s2">&quot;Library Selection&quot;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s2">&quot;Platform&quot;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s2">&quot;Organism&quot;</span><span class="p">,</span> <span class="s2">&quot;Publication Date&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Library Source&quot;</span><span class="p">,</span> <span class="s2">&quot;Publication Date&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Library Selection&quot;</span><span class="p">,</span> <span class="s2">&quot;Publication Date&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Platform&quot;</span><span class="p">,</span> <span class="s2">&quot;Publication Date&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Library Source&quot;</span><span class="p">,</span> <span class="s2">&quot;Organism&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Library Selection&quot;</span><span class="p">,</span> <span class="s2">&quot;Organism&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Platform&quot;</span><span class="p">,</span> <span class="s2">&quot;Organism&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Library Selection&quot;</span><span class="p">,</span> <span class="s2">&quot;Library Source&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Platform&quot;</span><span class="p">,</span> <span class="s2">&quot;Library Source&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Platform&quot;</span><span class="p">,</span> <span class="s2">&quot;Library Selection&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">plot_keys</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;daterange&quot;</span><span class="p">:</span> <span class="s2">&quot;Publication Date&quot;</span><span class="p">,</span>
            <span class="s2">&quot;organism&quot;</span><span class="p">:</span> <span class="s2">&quot;Organism&quot;</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;Library Source&quot;</span><span class="p">,</span>
            <span class="s2">&quot;selection&quot;</span><span class="p">:</span> <span class="s2">&quot;Library Selection&quot;</span><span class="p">,</span>
            <span class="s2">&quot;platform&quot;</span><span class="p">:</span> <span class="s2">&quot;Platform&quot;</span><span class="p">,</span>
            <span class="s2">&quot;basecount&quot;</span><span class="p">:</span> <span class="s2">&quot;Base Count&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;all&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph_types</span><span class="p">:</span>
            <span class="n">selected_plots</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">graph_type</span> <span class="ow">in</span> <span class="n">graph_types</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">graph_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plot_keys</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">plot</span> <span class="ow">in</span> <span class="n">plots</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">plot_keys</span><span class="p">[</span><span class="n">graph_type</span><span class="p">]</span> <span class="ow">in</span> <span class="n">plot</span> <span class="ow">and</span> <span class="n">plot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selected_plots</span><span class="p">:</span>
                        <span class="n">selected_plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span>
            <span class="n">plots</span> <span class="o">=</span> <span class="n">selected_plots</span>
        <span class="n">too_many_organisms</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;graph_raw&quot;</span><span class="p">][</span><span class="s2">&quot;Organism&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Too many types of organisms to plot (&gt;30). Showing only top 30 organisms.&quot;</span>
            <span class="p">)</span>
            <span class="n">too_many_organisms</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">plot</span> <span class="ow">in</span> <span class="n">plots</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_graph</span><span class="p">(</span><span class="n">plt</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">show</span><span class="p">,</span> <span class="n">saveto</span><span class="p">,</span> <span class="n">too_many_organisms</span><span class="p">)</span></div>

<div class="viewcode-block" id="QuerySearch.search"><a class="viewcode-back" href="../../pysradb.html#pysradb.search.QuerySearch.search">[docs]</a>    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="QuerySearch.get_df"><a class="viewcode-back" href="../../pysradb.html#pysradb.search.QuerySearch.get_df">[docs]</a>    <span class="k">def</span> <span class="nf">get_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Getter for the search result dataframe.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span></div>

<div class="viewcode-block" id="QuerySearch.get_plot_objects"><a class="viewcode-back" href="../../pysradb.html#pysradb.search.QuerySearch.get_plot_objects">[docs]</a>    <span class="k">def</span> <span class="nf">get_plot_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the plot objects for plots generated.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_objects</span></div>

    <span class="k">def</span> <span class="nf">_plot_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plt</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">show</span><span class="p">,</span> <span class="n">savedir</span><span class="p">,</span> <span class="n">too_many_organisms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plots a graph based on data from self.stats</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        axes: tuple</span>
<span class="sd">            tuple containing 1 or 2 strings corresponding to the statistics</span>
<span class="sd">            to plot. 1 string: Histogram. 2 string: heat map</span>
<span class="sd">        savedir: str</span>
<span class="sd">            directory to save to</span>
<span class="sd">        show: bool</span>
<span class="sd">            whether to call plt.show</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H-%M-%S&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;Publication Date&quot;</span> <span class="ow">in</span> <span class="n">axes</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;graph_raw&quot;</span><span class="p">][</span><span class="s2">&quot;Publication Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">30</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;graph_raw&quot;</span><span class="p">][</span><span class="s2">&quot;Publication Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;graph_raw&quot;</span><span class="p">][</span>
                <span class="s2">&quot;Publication Date&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">axes</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;Base Count&quot;</span><span class="p">,):</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;count_data&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Histogram of Base Count&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">count</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#135c1c&quot;</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Base Count&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{savedir}{title}</span><span class="s2"> </span><span class="si">{timestamp}</span><span class="s2">.svg&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_objects</span><span class="p">[</span><span class="n">axes</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Histogram of </span><span class="si">{axes[0]}</span><span class="s2">&quot;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;graph_raw&quot;</span><span class="p">][</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">too_many_organisms</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
                <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">)),</span>
                <span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                <span class="n">tick_label</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#135c1c&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{savedir}{title}</span><span class="s2"> </span><span class="si">{timestamp}</span><span class="s2">.svg&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_objects</span><span class="p">[</span><span class="n">axes</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Heatmap of </span><span class="si">{axes[0]}</span><span class="s2"> against </span><span class="si">{axes[1]}</span><span class="s2">&quot;</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;graph_raw&quot;</span><span class="p">][</span><span class="nb">list</span><span class="p">(</span><span class="n">axes</span><span class="p">)]</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="n">i</span><span class="p">:</span> <span class="s2">&quot;value_counts&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]})</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{axes[1]}</span><span class="s2">_count&quot;</span><span class="p">})</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">axes</span><span class="p">))</span>
            <span class="n">piv</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
                    <span class="n">b</span><span class="p">,</span>
                    <span class="n">values</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{axes[1]}</span><span class="s2">_count&quot;</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                    <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                    <span class="n">margins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;All&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;All&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;All&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;All&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">too_many_organisms</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Organism&quot;</span><span class="p">:</span>
                    <span class="n">piv</span> <span class="o">=</span> <span class="n">piv</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">piv</span> <span class="o">=</span> <span class="n">piv</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">30</span><span class="p">]</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">piv</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greens&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">piv</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">piv</span><span class="o">.</span><span class="n">index</span><span class="p">)))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">piv</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">piv</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{savedir}{title}</span><span class="s2"> </span><span class="si">{timestamp}</span><span class="s2">.svg&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_objects</span><span class="p">[</span><span class="n">axes</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="SraSearch"><a class="viewcode-back" href="../../pysradb.html#pysradb.search.SraSearch">[docs]</a><span class="k">class</span> <span class="nc">SraSearch</span><span class="p">(</span><span class="n">QuerySearch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Subclass of QuerySearch that implements search by querying</span>
<span class="sd">    NCBI Entrez API</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    search()</span>
<span class="sd">        sends the user query via requests to NCBI Entrez API and returns</span>
<span class="sd">        search results as a pandas dataframe.</span>

<span class="sd">    show_result_statistics()</span>
<span class="sd">        Shows summary information about search results.</span>

<span class="sd">    visualise_results()</span>
<span class="sd">        Generate graphs that visualise the search results.</span>

<span class="sd">    get_plot_objects():</span>
<span class="sd">        Get the plot objects for plots generated.</span>

<span class="sd">    get_uids():</span>
<span class="sd">        Get NCBI uids retrieved during this search query.</span>

<span class="sd">    _format_query_string()</span>
<span class="sd">        formats the input user query into a string</span>

<span class="sd">    _format_request()</span>
<span class="sd">        formats the request payload</span>

<span class="sd">    _format_result(content)</span>
<span class="sd">        formats the search query output.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    QuerySearch: Superclass of SraSearch</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">return_max</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">accession</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">organism</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">layout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mbases</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">publication_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">platform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">selection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">strategy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">suppress_validation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">verbosity</span><span class="p">,</span>
            <span class="n">return_max</span><span class="p">,</span>
            <span class="n">query</span><span class="p">,</span>
            <span class="n">accession</span><span class="p">,</span>
            <span class="n">organism</span><span class="p">,</span>
            <span class="n">layout</span><span class="p">,</span>
            <span class="n">mbases</span><span class="p">,</span>
            <span class="n">publication_date</span><span class="p">,</span>
            <span class="n">platform</span><span class="p">,</span>
            <span class="n">selection</span><span class="p">,</span>
            <span class="n">source</span><span class="p">,</span>
            <span class="n">strategy</span><span class="p">,</span>
            <span class="n">title</span><span class="p">,</span>
            <span class="n">suppress_validation</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_entries</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uids</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="SraSearch.search"><a class="viewcode-back" href="../../pysradb.html#pysradb.search.SraSearch.search">[docs]</a>    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Step 1: retrieves the list of uids that satisfies the input</span>
        <span class="c1"># search query</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_request</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests_3_retries</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi&quot;</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">SEARCH_REQUEST_TIMEOUT</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uids</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;esearchresult&quot;</span><span class="p">][</span><span class="s2">&quot;idlist&quot;</span><span class="p">]</span>

            <span class="c1"># Step 2: retrieves the detailed information for each uid</span>
            <span class="c1"># returned, in groups of SRA_SEARCH_GROUP_SIZE.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">uids</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No results found for the following search query: </span><span class="se">\n</span><span class="s2"> </span><span class="si">{self.fields}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>  <span class="c1"># If no queries found, return nothing</span>
            <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uids</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uids</span><span class="p">),</span> <span class="n">SRA_SEARCH_GROUP_SIZE</span><span class="p">):</span>
                <span class="n">current_uids</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">uids</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">SRA_SEARCH_GROUP_SIZE</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uids</span><span class="p">))]</span>
                <span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">SRA_SEARCH_GROUP_SIZE</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uids</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span><span class="p">))</span>
                <span class="n">payload2</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;db&quot;</span><span class="p">:</span> <span class="s2">&quot;sra&quot;</span><span class="p">,</span> <span class="s2">&quot;retmode&quot;</span><span class="p">:</span> <span class="s2">&quot;xml&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">current_uids</span><span class="p">}</span>

                <span class="n">r</span> <span class="o">=</span> <span class="n">requests_3_retries</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi&quot;</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="n">payload2</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">SEARCH_REQUEST_TIMEOUT</span><span class="p">,</span>
                    <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                <span class="n">r</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode_content</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_format_response</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_format_result</span><span class="p">()</span>

        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection to the server has timed out. Please retry.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;HTTPError: This is likely caused by an invalid search query: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">URL queried: </span><span class="si">{r.url}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">User query: </span><span class="si">{self.fields}</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="SraSearch.get_uids"><a class="viewcode-back" href="../../pysradb.html#pysradb.search.SraSearch.get_uids">[docs]</a>    <span class="k">def</span> <span class="nf">get_uids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get NCBI uids retrieved during this search query.</span>

<span class="sd">        Note: There is a chance that some uids retrieved do not appear in</span>
<span class="sd">        the search result output (Refer to #88)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">uids</span></div>

    <span class="k">def</span> <span class="nf">_format_query_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">term</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; AND &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;accession&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;accession&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;[Accession] AND &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;organism&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;organism&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;[Organism] AND &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;layout&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;layout&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;[Layout] AND &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;mbases&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;mbases&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;[Mbases] AND &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;publication_date&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;publication_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;[PDAT] AND &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;[Platform] AND &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;selection&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;selection&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;[Selection] AND &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;[Source] AND &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;strategy&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;strategy&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;[Strategy] AND &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;[Title] AND &quot;</span>
        <span class="k">return</span> <span class="n">term</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>  <span class="c1"># Removing trailing &quot; AND &quot;</span>

    <span class="k">def</span> <span class="nf">_format_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;db&quot;</span><span class="p">:</span> <span class="s2">&quot;sra&quot;</span><span class="p">,</span>
            <span class="s2">&quot;term&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_query_string</span><span class="p">(),</span>
            <span class="s2">&quot;retmode&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;retmax&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_max</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">payload</span>

    <span class="k">def</span> <span class="nf">_format_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="n">field_categories</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;EXPERIMENT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SUBMISSION&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ORGANISATION&quot;</span><span class="p">,</span>
            <span class="s2">&quot;STUDY&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SAMPLE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Pool&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RUN_SET&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">Et</span><span class="o">.</span><span class="n">iterparse</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;EXPERIMENT_PACKAGE&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">number_entries</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="n">field_categories</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_entry</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="n">field</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_entries</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">number_entries</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_format_result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;^\s*$&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># Tabulate statistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_stats</span><span class="p">()</span>

        <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">important_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;study_accession&quot;</span><span class="p">,</span>
            <span class="s2">&quot;experiment_accession&quot;</span><span class="p">,</span>
            <span class="s2">&quot;experiment_title&quot;</span><span class="p">,</span>
            <span class="s2">&quot;design_description&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sample_taxon_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sample_scientific_name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;experiment_library_strategy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;experiment_library_source&quot;</span><span class="p">,</span>
            <span class="s2">&quot;experiment_library_selection&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sample_accession&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sample_alias&quot;</span><span class="p">,</span>
            <span class="s2">&quot;experiment_instrument_model&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pool_member_spots&quot;</span><span class="p">,</span>
            <span class="s2">&quot;run_1_size&quot;</span><span class="p">,</span>
            <span class="s2">&quot;run_1_accession&quot;</span><span class="p">,</span>
            <span class="s2">&quot;run_1_total_spots&quot;</span><span class="p">,</span>
            <span class="s2">&quot;run_1_total_bases&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">temp_cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">important_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                <span class="n">temp_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">important_columns</span> <span class="o">=</span> <span class="n">temp_cols</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">temp_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;run_[0-9]+_accession&quot;</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
                    <span class="n">temp_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[[</span><span class="n">col</span><span class="p">,</span> <span class="s2">&quot;experiment_title&quot;</span><span class="p">]]</span>
                    <span class="n">temp_df</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">temp_df</span><span class="p">[</span><span class="n">col</span><span class="p">])]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                        <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                            <span class="n">col</span><span class="p">:</span> <span class="s2">&quot;run_accession&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;experiment_title&quot;</span><span class="p">:</span> <span class="s2">&quot;experiment_title&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                    <span class="n">temp_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_df</span><span class="p">)</span>
            <span class="n">run_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">temp_dfs</span><span class="p">)</span>
            <span class="n">run_dataframe</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;run_accession&quot;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;mergesort&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">run_dataframe</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;run_accession&quot;</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># df has already been formatted above</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">important_columns</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">important_columns</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">columns</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_root</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parses a subset of the XML tree from request stream</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        entry_root: ElementTree.Element</span>
<span class="sd">            root element of the xml tree from requests stream</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_header</span> <span class="o">=</span> <span class="n">entry_root</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">run_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># root element attributes</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">entry_root</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_entry</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{field_header}</span><span class="s2">_</span><span class="si">{k}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">entry_root</span><span class="p">:</span>
            <span class="c1"># &quot;*_REF&quot; tags contain duplicate information that can be found</span>
            <span class="c1"># somewhere in the xml entry and are skipped</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_REF&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="c1"># IDENTIFIERS contain two types of children tags:</span>
            <span class="c1"># PRIMARY_ID, which repeats the accession number and</span>
            <span class="c1"># EXTERNAL_ID tags, each containing an alternative ID that is</span>
            <span class="c1"># typically used in another database (GEO, ENA etc)</span>
            <span class="c1"># IDs are numbered from 1 to differentiate between them.</span>
            <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;IDENTIFIERS&quot;</span><span class="p">:</span>
                <span class="n">id_index</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">child</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">identifier</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;EXTERNAL_ID&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_update_entry</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{field_header}</span><span class="s2">_external_id_</span><span class="si">{id_index}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">identifier</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_update_entry</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{field_header}</span><span class="s2">_external_id_</span><span class="si">{id_index}</span><span class="s2">_namespace&quot;</span><span class="p">,</span>
                            <span class="n">identifier</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;namespace&quot;</span><span class="p">),</span>
                        <span class="p">)</span>
            <span class="c1"># &quot;*_LINKS&quot; tags contain 0 or more &quot;*_LINK&quot; children tags,</span>
            <span class="c1"># each containing information (values) regarding the link</span>
            <span class="c1"># Links are numbered from 1 to differentiate between multiple</span>
            <span class="c1"># links.</span>
            <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_LINKS&quot;</span><span class="p">):</span>
                <span class="n">link_index</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">child</span><span class="p">:</span>
                    <span class="c1"># Link type. Eg: URL_link, Xref_link</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_entry</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{link.tag}</span><span class="s2">_</span><span class="si">{link_index}</span><span class="s2">_type&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                        <span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="c1"># Link values in the form of tag: value.</span>
                    <span class="c1"># Eg: label: GEO sample</span>
                    <span class="n">link_value_index</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">link_value</span> <span class="ow">in</span> <span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_update_entry</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{link.tag}</span><span class="s2">_</span><span class="si">{link_index}</span><span class="s2">_value_</span><span class="si">{link_value_index}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{link_value.tag}</span><span class="s2">: </span><span class="si">{link_value.text}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">link_value_index</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">link_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># &quot;*_ATTRIBUTES&quot; tags contain tag - value pairs providing</span>
            <span class="c1"># additional information for the Experiment/Sample/Study</span>
            <span class="c1"># Attributes are numbered from 1 to differentiate between</span>
            <span class="c1"># multiple attributes.</span>
            <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_ATTRIBUTES&quot;</span><span class="p">):</span>
                <span class="n">attribute_index</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">child</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">attribute</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_update_entry</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{child.tag}</span><span class="s2">_</span><span class="si">{attribute_index}</span><span class="s2">_</span><span class="si">{val.tag}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                            <span class="n">val</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="n">attribute_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># Differentiating between sample title and experiment title.</span>
            <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;TITLE&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_entry</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{field_header}</span><span class="s2">_title&quot;</span><span class="p">,</span> <span class="n">child</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="c1"># Parsing platfrom information</span>
            <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;PLATFORM&quot;</span><span class="p">:</span>
                <span class="n">platform</span> <span class="o">=</span> <span class="n">child</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_entry</span><span class="p">(</span><span class="s2">&quot;experiment_platform&quot;</span><span class="p">,</span> <span class="n">platform</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_entry</span><span class="p">(</span>
                    <span class="s2">&quot;experiment_instrument_model&quot;</span><span class="p">,</span>
                    <span class="n">platform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># Parsing individual run information</span>
            <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;RUN&quot;</span><span class="p">:</span>
                <span class="n">run_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># run attributes</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_entry</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_</span><span class="si">{run_count}</span><span class="s2">_</span><span class="si">{k}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">v</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">child</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;SRAFiles&quot;</span><span class="p">:</span>
                        <span class="n">srafile_index</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">for</span> <span class="n">srafile</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">srafile</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_update_entry</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;run_</span><span class="si">{run_count}</span><span class="s2">_srafile_</span><span class="si">{srafile_index}</span><span class="s2">_</span><span class="si">{k}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                    <span class="n">v</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="n">alternatives_index</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">for</span> <span class="n">alternatives</span> <span class="ow">in</span> <span class="n">srafile</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">alternatives</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_entry</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s2">&quot;run_</span><span class="si">{run_count}</span><span class="s2">_srafile_</span><span class="si">{srafile_index}</span><span class="s2">_alternative_</span><span class="si">{alternatives_index}</span><span class="s2">_</span><span class="si">{k}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                        <span class="n">v</span><span class="p">,</span>
                                    <span class="p">)</span>
                                <span class="n">alternatives_index</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">srafile_index</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;CloudFiles&quot;</span><span class="p">:</span>
                        <span class="n">cloudfile_index</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">for</span> <span class="n">cloudfile</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cloudfile</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_update_entry</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;run_</span><span class="si">{run_count}</span><span class="s2">_cloudfile_</span><span class="si">{cloudfile_index}</span><span class="s2">_</span><span class="si">{k}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                    <span class="n">v</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="n">cloudfile_index</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;Bases&quot;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">elem</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_update_entry</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;run_</span><span class="si">{run_count}</span><span class="s2">_total_base_</span><span class="si">{k}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                <span class="n">v</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_update_entry</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;run_</span><span class="si">{run_count}</span><span class="s2">_base_</span><span class="si">{base.attrib[&#39;value&#39;]}</span><span class="s2">_count&quot;</span><span class="p">,</span>
                                <span class="n">base</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">],</span>
                            <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;Databases&quot;</span><span class="p">:</span>
                        <span class="n">database_index</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_update_entry</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;run_</span><span class="si">{run_count}</span><span class="s2">_database_</span><span class="si">{database_index}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                <span class="n">Et</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">database</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
                            <span class="p">)</span>
                            <span class="n">database_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">iter</span><span class="p">():</span>
                    <span class="c1"># Tags to ignore to avoid confusion</span>
                    <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;PRIMARY_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;SINGLE&quot;</span><span class="p">,</span> <span class="s2">&quot;PAIRED&quot;</span><span class="p">]:</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">elem</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_update_entry</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{field_header}</span><span class="s2">_{elem.tag.lower()}&quot;</span><span class="p">,</span>
                            <span class="n">elem</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">elem</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">elem</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_update_entry</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{field_header}</span><span class="s2">_</span><span class="si">{elem.tag}</span><span class="s2">_</span><span class="si">{k}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                <span class="n">v</span><span class="p">,</span>
                            <span class="p">)</span>
            <span class="c1"># Parsing library layout (single, paired)</span>
            <span class="k">if</span> <span class="n">field_header</span> <span class="o">==</span> <span class="s2">&quot;experiment&quot;</span><span class="p">:</span>
                <span class="n">library_layout</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;./LIBRARY_DESCRIPTOR/LIBRARY_LAYOUT&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">library_layout</span><span class="p">:</span>
                    <span class="n">library_layout</span> <span class="o">=</span> <span class="n">library_layout</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_entry</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;library_layout&quot;</span><span class="p">,</span> <span class="n">library_layout</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
                    <span class="c1"># If library layout is paired, information such as nominal</span>
                    <span class="c1"># standard deviation and length, etc are provided as well.</span>
                    <span class="k">if</span> <span class="n">library_layout</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;PAIRED&quot;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">library_layout</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_update_entry</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;library_layout_</span><span class="si">{k}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                <span class="n">v</span><span class="p">,</span>
                            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds information from a field into the entries dictionary</span>

<span class="sd">        This is a helper function that adds information parsed from the XML</span>
<span class="sd">        output from SRA into a dictionary of lists, for easier conversion</span>
<span class="sd">        into a Pandas dataframe later. Dictionary key is created if it</span>
<span class="sd">        doesn&#39;t exist yet. For entries that does not have information</span>
<span class="sd">        belonging to a field, the corresponding list will be padded with</span>
<span class="sd">        empty strings.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        field_name: str</span>
<span class="sd">            Name of the field where a value belonging to an entry is to be</span>
<span class="sd">            added</span>
<span class="sd">        field_content: str</span>
<span class="sd">            Value to be added</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_entries</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_entries</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span>
        <span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">field_content</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_update_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># study</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;study&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;study_accession&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
        <span class="c1"># experiment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;experiment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;experiment_accession&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
        <span class="c1"># run</span>
        <span class="n">runs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_selected_columns</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^run.*accession$&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">runs</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runs</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
        <span class="c1"># sample</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_selected_columns</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^sample.*accession$&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">samples</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
        <span class="c1"># date range</span>
        <span class="n">daterange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_selected_columns</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^run_1_published$&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">daterange</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">daterange</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Date range&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="c1"># organisms</span>
        <span class="n">organisms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_selected_columns</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^sample.*scientific_name.*&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">organisms</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Organisms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">organisms</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="c1"># strategy</span>
        <span class="k">if</span> <span class="s2">&quot;experiment_library_strategy&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Library strategy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;experiment_library_strategy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="c1"># source</span>
        <span class="k">if</span> <span class="s2">&quot;experiment_library_source&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Library source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;experiment_library_source&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="c1"># selection</span>
        <span class="k">if</span> <span class="s2">&quot;experiment_library_selection&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Library selection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;experiment_library_selection&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="c1"># layout</span>
        <span class="k">if</span> <span class="s2">&quot;library_layout&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Library layout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;library_layout&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="c1"># platform</span>
        <span class="k">if</span> <span class="s2">&quot;experiment_platform&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Platform&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;experiment_platform&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="c1"># count</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_selected_columns</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^run_.*_total_bases$&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;count_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;count_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;count_median&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;count_stdev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="c1"># for graphing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;graph_raw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span>
            <span class="p">[</span>
                <span class="s2">&quot;sample_scientific_name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;experiment_library_strategy&quot;</span><span class="p">,</span>
                <span class="s2">&quot;experiment_library_source&quot;</span><span class="p">,</span>
                <span class="s2">&quot;experiment_library_selection&quot;</span><span class="p">,</span>
                <span class="s2">&quot;run_1_published&quot;</span><span class="p">,</span>
                <span class="s2">&quot;experiment_platform&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;sample_scientific_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Organism&quot;</span><span class="p">,</span>
                <span class="s2">&quot;experiment_library_strategy&quot;</span><span class="p">:</span> <span class="s2">&quot;Library Strategy&quot;</span><span class="p">,</span>
                <span class="s2">&quot;experiment_library_source&quot;</span><span class="p">:</span> <span class="s2">&quot;Library Source&quot;</span><span class="p">,</span>
                <span class="s2">&quot;experiment_library_selection&quot;</span><span class="p">:</span> <span class="s2">&quot;Library Selection&quot;</span><span class="p">,</span>
                <span class="s2">&quot;run_1_published&quot;</span><span class="p">:</span> <span class="s2">&quot;Publication Date&quot;</span><span class="p">,</span>
                <span class="s2">&quot;experiment_platform&quot;</span><span class="p">:</span> <span class="s2">&quot;Platform&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;graph_raw&quot;</span><span class="p">][</span><span class="s2">&quot;Publication Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;graph_raw&quot;</span><span class="p">][</span><span class="s2">&quot;Publication Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_merge_selected_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regex</span><span class="p">):</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">series</span><span class="p">[</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">series</span><span class="p">)]</span></div>


<div class="viewcode-block" id="EnaSearch"><a class="viewcode-back" href="../../pysradb.html#pysradb.search.EnaSearch">[docs]</a><span class="k">class</span> <span class="nc">EnaSearch</span><span class="p">(</span><span class="n">QuerySearch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Subclass of QuerySearch that implements search via querying ENA API</span>


<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    search()</span>
<span class="sd">        sends the user query via requests to ENA API and stores search</span>
<span class="sd">        result as an instance attribute in the form of a pandas dataframe</span>

<span class="sd">    show_result_statistics()</span>
<span class="sd">        Shows summary information about search results.</span>

<span class="sd">    visualise_results()</span>
<span class="sd">        Generate graphs that visualise the search results.</span>

<span class="sd">    get_plot_objects():</span>
<span class="sd">        Get the plot objects for plots generated.</span>

<span class="sd">    _format_query_string()</span>
<span class="sd">        formats the input user query into a string</span>

<span class="sd">    _format_request()</span>
<span class="sd">        formats the request payload</span>

<span class="sd">    _format_result(content)</span>
<span class="sd">        formats the search query output and converts it into a pandas</span>
<span class="sd">        dataframe</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    QuerySearch: Superclass of EnaSearch</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EnaSearch.search"><a class="viewcode-back" href="../../pysradb.html#pysradb.search.EnaSearch.search">[docs]</a>    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This ensures that the spaces in the query string are not</span>
        <span class="c1"># converted to &#39;+&#39; by requests.</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_format_request</span><span class="p">(),</span> <span class="n">quote_via</span><span class="o">=</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests_3_retries</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;https://www.ebi.ac.uk/ena/portal/api/search&quot;</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">SEARCH_REQUEST_TIMEOUT</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_format_result</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection to the server has timed out. Please retry.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;HTTPError: This is likely caused by an invalid search query: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">URL queried: </span><span class="si">{r.url}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">User query: </span><span class="si">{self.fields}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">JSONDecodeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No results found for the following search query: </span><span class="se">\n</span><span class="s2"> </span><span class="si">{self.fields}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>  <span class="c1"># no results found</span></div>

    <span class="k">def</span> <span class="nf">_format_query_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">term</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="sa">rf</span><span class="s1">&#39;(experiment_title=&quot;*</span><span class="si">{self.fields[&quot;query&quot;]}</span><span class="s1">*&quot;&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;accession&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="n">term</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="sa">rf</span><span class="s1">&#39; OR study_accession=&quot;</span><span class="si">{self.fields[&quot;query&quot;]}</span><span class="s1">&quot; OR &#39;</span>
                    <span class="sa">rf</span><span class="s1">&#39;secondary_study_accession=&quot;</span><span class="si">{self.fields[&quot;query&quot;]}</span><span class="s1">&quot; OR &#39;</span>
                    <span class="sa">rf</span><span class="s1">&#39;sample_accession=&quot;</span><span class="si">{self.fields[&quot;query&quot;]}</span><span class="s1">&quot; OR &#39;</span>
                    <span class="sa">rf</span><span class="s1">&#39;secondary_sample_accession=&quot;</span><span class="si">{self.fields[&quot;query&quot;]}</span><span class="s1">&quot; OR &#39;</span>
                    <span class="sa">rf</span><span class="s1">&#39;experiment_accession=&quot;</span><span class="si">{self.fields[&quot;query&quot;]}</span><span class="s1">&quot; OR &#39;</span>
                    <span class="sa">rf</span><span class="s1">&#39;submission_accession=&quot;</span><span class="si">{self.fields[&quot;query&quot;]}</span><span class="s1">&quot; OR &#39;</span>
                    <span class="sa">rf</span><span class="s1">&#39;run_accession=&quot;</span><span class="si">{self.fields[&quot;query&quot;]}</span><span class="s1">&quot;&#39;</span>
                <span class="p">)</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="s2">&quot;) AND &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;accession&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;accession&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;accession&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="sa">rf</span><span class="s1">&#39;(study_accession=&quot;</span><span class="si">{self.fields[&quot;accession&quot;]}</span><span class="s1">&quot; OR &#39;</span>
                <span class="sa">rf</span><span class="s1">&#39;secondary_study_accession=&quot;</span><span class="si">{self.fields[&quot;accession&quot;]}</span><span class="s1">&quot; OR &#39;</span>
                <span class="sa">rf</span><span class="s1">&#39;sample_accession=&quot;</span><span class="si">{self.fields[&quot;accession&quot;]}</span><span class="s1">&quot; OR &#39;</span>
                <span class="sa">rf</span><span class="s1">&#39;secondary_sample_accession=&quot;</span><span class="si">{self.fields[&quot;accession&quot;]}</span><span class="s1">&quot; OR &#39;</span>
                <span class="sa">rf</span><span class="s1">&#39;experiment_accession=&quot;</span><span class="si">{self.fields[&quot;accession&quot;]}</span><span class="s1">&quot; OR &#39;</span>
                <span class="sa">rf</span><span class="s1">&#39;submission_accession=&quot;</span><span class="si">{self.fields[&quot;accession&quot;]}</span><span class="s1">&quot; OR &#39;</span>
                <span class="sa">rf</span><span class="s1">&#39;run_accession=&quot;</span><span class="si">{self.fields[&quot;accession&quot;]}</span><span class="s1">&quot;) AND &#39;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;organism&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="sa">rf</span><span class="s1">&#39;tax_eq({scientific_name_to_taxid(self.fields[&quot;organism&quot;])}) AND &#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;layout&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="sa">rf</span><span class="s1">&#39;library_layout=&quot;{self.fields[&quot;layout&quot;].upper()}&quot; AND &#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;mbases&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;mbases&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">IncorrectFieldException</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Incorrect mbases format: </span><span class="si">{self.fields[&#39;mbases&#39;]}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;--mbases must be an integer&quot;</span>
                <span class="p">)</span>
            <span class="n">upper_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;mbases&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">+</span> <span class="mi">500000</span>
            <span class="n">lower_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;mbases&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">-</span> <span class="mi">500000</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="sa">rf</span><span class="s2">&quot;base_count&gt;=</span><span class="si">{lower_limit}</span><span class="s2"> AND base_count&lt;</span><span class="si">{upper_limit}</span><span class="s2"> AND &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;publication_date&quot;</span><span class="p">]:</span>
            <span class="n">dates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;publication_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)):</span>
                <span class="n">dates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">term</span> <span class="o">+=</span> <span class="sa">rf</span><span class="s2">&quot;first_created=</span><span class="si">{dates[0]}</span><span class="s2"> AND &quot;</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">term</span> <span class="o">+=</span> <span class="sa">rf</span><span class="s2">&quot;first_created&gt;=</span><span class="si">{dates[0]}</span><span class="s2"> AND first_created&lt;=</span><span class="si">{dates[1]}</span><span class="s2"> AND &quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">IncorrectFieldException</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Incorrect publication date format: </span><span class="si">{self.fields[&#39;publication_date&#39;]}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Expected format: dd-mm-yyyy or dd-mm-yyyy:dd-mm-yyyy&quot;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="sa">rf</span><span class="s1">&#39;instrument_platform=&quot;</span><span class="si">{self.fields[&quot;platform&quot;]}</span><span class="s1">&quot; AND &#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;selection&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="sa">rf</span><span class="s1">&#39;library_selection=&quot;</span><span class="si">{self.fields[&quot;selection&quot;]}</span><span class="s1">&quot; AND &#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="sa">rf</span><span class="s1">&#39;library_source=&quot;</span><span class="si">{self.fields[&quot;source&quot;]}</span><span class="s1">&quot; AND &#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;strategy&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="sa">rf</span><span class="s1">&#39;library_strategy=&quot;</span><span class="si">{self.fields[&quot;strategy&quot;]}</span><span class="s1">&quot; AND &#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="sa">rf</span><span class="s1">&#39;experiment_title=&quot;*</span><span class="si">{self.fields[&quot;title&quot;]}</span><span class="s1">*&quot; AND &#39;</span>
        <span class="k">return</span> <span class="n">term</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>  <span class="c1"># Removing trailing &quot; AND &quot;</span>

    <span class="k">def</span> <span class="nf">_format_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Note: ENA&#39;s API does not support searching a query in all fields.</span>
        <span class="c1"># Currently, if the user does not specify a query field, the query will</span>
        <span class="c1"># be matched to experiment_title (aka description),</span>
        <span class="c1"># or one of the accession fields</span>
        <span class="n">stats_columns</span> <span class="o">=</span> <span class="p">()</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_query_string</span><span class="p">(),</span>
            <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;read_run&quot;</span><span class="p">,</span>
            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_max</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Selects the fields to return at different verbosity levels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;fields&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;study_accession,&quot;</span>
                <span class="s2">&quot;experiment_accession,&quot;</span>
                <span class="s2">&quot;experiment_title,&quot;</span>
                <span class="s2">&quot;description,&quot;</span>
                <span class="s2">&quot;tax_id,&quot;</span>
                <span class="s2">&quot;scientific_name,&quot;</span>
                <span class="s2">&quot;library_strategy,&quot;</span>
                <span class="s2">&quot;library_source,&quot;</span>
                <span class="s2">&quot;library_selection,&quot;</span>
                <span class="s2">&quot;sample_accession,&quot;</span>
                <span class="s2">&quot;sample_title,&quot;</span>
                <span class="s2">&quot;instrument_model,&quot;</span>
                <span class="s2">&quot;run_accession,&quot;</span>
                <span class="s2">&quot;read_count,&quot;</span>
                <span class="s2">&quot;base_count,&quot;</span>
                <span class="s2">&quot;first_public,&quot;</span>
                <span class="s2">&quot;library_layout,&quot;</span>
                <span class="s2">&quot;instrument_platform&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;fields&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>
        <span class="k">return</span> <span class="n">payload</span>

    <span class="k">def</span> <span class="nf">_format_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*$&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Tabulate statistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_stats</span><span class="p">()</span>

        <span class="n">important_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;study_accession&quot;</span><span class="p">,</span>
            <span class="s2">&quot;experiment_accession&quot;</span><span class="p">,</span>
            <span class="s2">&quot;experiment_title&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tax_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;scientific_name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;library_strategy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;library_source&quot;</span><span class="p">,</span>
            <span class="s2">&quot;library_selection&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sample_accession&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sample_title&quot;</span><span class="p">,</span>
            <span class="s2">&quot;instrument_model&quot;</span><span class="p">,</span>
            <span class="s2">&quot;run_accession&quot;</span><span class="p">,</span>
            <span class="s2">&quot;read_count&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base_count&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;run_accession&quot;</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;run_accession&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">important_columns</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">important_columns</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">important_columns</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># study</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;study&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;study_accession&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
        <span class="c1"># experiment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;experiment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;experiment_accession&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
        <span class="c1"># run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;run_accession&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
        <span class="c1"># sample</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;sample_accession&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
        <span class="c1"># date range</span>
        <span class="n">daterange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;first_public&quot;</span><span class="p">]</span>
        <span class="n">daterange</span> <span class="o">=</span> <span class="n">daterange</span><span class="p">[</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">daterange</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">daterange</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">daterange</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Date range&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="c1"># organisms</span>
        <span class="n">organisms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;scientific_name&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Organisms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">organisms</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="c1"># strategy</span>
        <span class="k">if</span> <span class="s2">&quot;library_strategy&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Library strategy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;library_strategy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="c1"># source</span>
        <span class="k">if</span> <span class="s2">&quot;library_source&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Library source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;library_source&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="c1"># selection</span>
        <span class="k">if</span> <span class="s2">&quot;library_selection&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Library selection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;library_selection&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="c1"># layout</span>
        <span class="k">if</span> <span class="s2">&quot;library_layout&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Library layout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;library_layout&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="c1"># platform</span>
        <span class="k">if</span> <span class="s2">&quot;instrument_platform&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Platform&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;instrument_platform&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="c1"># count</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;base_count&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="p">[</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">count</span><span class="p">)]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;count_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;count_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;count_median&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;count_stdev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="c1"># For graphing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;graph_raw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span>
            <span class="p">[</span>
                <span class="s2">&quot;scientific_name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;library_strategy&quot;</span><span class="p">,</span>
                <span class="s2">&quot;library_source&quot;</span><span class="p">,</span>
                <span class="s2">&quot;library_selection&quot;</span><span class="p">,</span>
                <span class="s2">&quot;first_public&quot;</span><span class="p">,</span>
                <span class="s2">&quot;instrument_platform&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;scientific_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Organism&quot;</span><span class="p">,</span>
                <span class="s2">&quot;library_strategy&quot;</span><span class="p">:</span> <span class="s2">&quot;Library Strategy&quot;</span><span class="p">,</span>
                <span class="s2">&quot;library_source&quot;</span><span class="p">:</span> <span class="s2">&quot;Library Source&quot;</span><span class="p">,</span>
                <span class="s2">&quot;library_selection&quot;</span><span class="p">:</span> <span class="s2">&quot;Library Selection&quot;</span><span class="p">,</span>
                <span class="s2">&quot;first_public&quot;</span><span class="p">:</span> <span class="s2">&quot;Publication Date&quot;</span><span class="p">,</span>
                <span class="s2">&quot;instrument_platform&quot;</span><span class="p">:</span> <span class="s2">&quot;Platform&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;graph_raw&quot;</span><span class="p">][</span><span class="s2">&quot;Publication Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;graph_raw&quot;</span><span class="p">][</span><span class="s2">&quot;Publication Date&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GeoSearch"><a class="viewcode-back" href="../../pysradb.html#pysradb.search.GeoSearch">[docs]</a><span class="k">class</span> <span class="nc">GeoSearch</span><span class="p">(</span><span class="n">SraSearch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Subclass of SraSearch that can query both GEO DataSets and SRA API.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    search()</span>
<span class="sd">        sends the user query via requests to SRA, GEO DataSets, or both</span>
<span class="sd">        depending on the search query. If query is sent to both APIs,</span>
<span class="sd">        the intersection of the two sets of query results are returned.</span>

<span class="sd">    show_result_statistics()</span>
<span class="sd">        Shows summary information about search results.</span>

<span class="sd">    visualise_results()</span>
<span class="sd">        Generate graphs that visualise the search results.</span>

<span class="sd">    get_plot_objects():</span>
<span class="sd">        Get the plot objects for plots generated.</span>

<span class="sd">    _format_geo_query_string()</span>
<span class="sd">        formats the GEO DataSets portion of the input user query into a</span>
<span class="sd">        string.</span>

<span class="sd">    _format_geo_request()</span>
<span class="sd">        formats the GEO DataSets request payload</span>

<span class="sd">    _format_result(content)</span>
<span class="sd">        formats the search query output and converts it into a pandas</span>
<span class="sd">        dataframe</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    GeoSearch.info: GeoSearch usage details</span>
<span class="sd">    SraSearch: Superclass of GeoSearch</span>
<span class="sd">    QuerySearch: Superclass of SraSearch</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">return_max</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">accession</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">organism</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">layout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mbases</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">publication_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">platform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">selection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">strategy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">geo_query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">geo_dataset_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">geo_entry_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">suppress_validation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geo_fields</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">geo_query</span><span class="p">,</span>
            <span class="s2">&quot;dataset_type&quot;</span><span class="p">:</span> <span class="n">geo_dataset_type</span><span class="p">,</span>
            <span class="s2">&quot;entry_type&quot;</span><span class="p">:</span> <span class="n">geo_entry_type</span><span class="p">,</span>
            <span class="s2">&quot;publication_date&quot;</span><span class="p">:</span> <span class="n">publication_date</span><span class="p">,</span>
            <span class="s2">&quot;organism&quot;</span><span class="p">:</span> <span class="n">organism</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geo_fields</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">geo_fields</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geo_fields</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search_sra</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search_geo</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_entries</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;study&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;experiment&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;run&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sample&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Date range&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Organisms&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Library strategy&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Library source&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Library selection&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Library layout&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Platform&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;count_mean&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;count_median&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;count_stdev&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                <span class="n">verbosity</span><span class="p">,</span>
                <span class="n">return_max</span><span class="p">,</span>
                <span class="n">query</span><span class="p">,</span>
                <span class="n">accession</span><span class="p">,</span>
                <span class="n">organism</span><span class="p">,</span>
                <span class="n">layout</span><span class="p">,</span>
                <span class="n">mbases</span><span class="p">,</span>
                <span class="n">publication_date</span><span class="p">,</span>
                <span class="n">platform</span><span class="p">,</span>
                <span class="n">selection</span><span class="p">,</span>
                <span class="n">source</span><span class="p">,</span>
                <span class="n">strategy</span><span class="p">,</span>
                <span class="n">title</span><span class="p">,</span>
                <span class="n">suppress_validation</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">MissingQueryException</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">search_sra</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geo_fields</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">search_geo</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_geo</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_sra</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MissingQueryException</span><span class="p">()</span>
        <span class="c1"># Narrowing down the total number of eligible uids</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot; AND sra gds[Filter]&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_sra</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;sra gds[Filter]&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo_fields</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geo_fields</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot; AND gds sra[Filter]&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_geo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geo_fields</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;gds sra[Filter]&quot;</span>

    <span class="k">def</span> <span class="nf">_format_geo_query_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">term</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo_fields</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo_fields</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; AND &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo_fields</span><span class="p">[</span><span class="s2">&quot;organism&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo_fields</span><span class="p">[</span><span class="s2">&quot;organism&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;[Organism] AND &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo_fields</span><span class="p">[</span><span class="s2">&quot;publication_date&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">geo_fields</span><span class="p">[</span><span class="s2">&quot;publication_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;[PDAT] AND &quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo_fields</span><span class="p">[</span><span class="s2">&quot;dataset_type&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo_fields</span><span class="p">[</span><span class="s2">&quot;dataset_type&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;[DataSet Type] AND &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo_fields</span><span class="p">[</span><span class="s2">&quot;entry_type&quot;</span><span class="p">]:</span>
            <span class="n">term</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo_fields</span><span class="p">[</span><span class="s2">&quot;entry_type&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;[Entry Type] AND &quot;</span>
        <span class="k">return</span> <span class="n">term</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>  <span class="c1"># Removing trailing &quot; AND &quot;</span>

    <span class="k">def</span> <span class="nf">_format_geo_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;db&quot;</span><span class="p">:</span> <span class="s2">&quot;gds&quot;</span><span class="p">,</span>
            <span class="s2">&quot;term&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_geo_query_string</span><span class="p">(),</span>
            <span class="s2">&quot;retmode&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;retmax&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_max</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s2">&quot;usehistory&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">payload</span>

    <span class="k">def</span> <span class="nf">_format_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_geo</span><span class="p">:</span>
            <span class="n">retmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_max</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_max</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;db&quot;</span><span class="p">:</span> <span class="s2">&quot;sra&quot;</span><span class="p">,</span>
            <span class="s2">&quot;term&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_query_string</span><span class="p">(),</span>
            <span class="s2">&quot;retmode&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;retmax&quot;</span><span class="p">:</span> <span class="n">retmax</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">payload</span>

<div class="viewcode-block" id="GeoSearch.search"><a class="viewcode-back" href="../../pysradb.html#pysradb.search.GeoSearch.search">[docs]</a>    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_geo</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">search</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Step 1: retrieves the list of uids from GEO DataSets, and use</span>
            <span class="c1"># ELink to find corresponding uids in SRA</span>
            <span class="n">geo_payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_geo_request</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">requests_3_retries</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi&quot;</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="n">geo_payload</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">SEARCH_REQUEST_TIMEOUT</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;esearchresult&quot;</span><span class="p">]</span>
                <span class="n">query_key</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;querykey&quot;</span><span class="p">]</span>
                <span class="n">web_env</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;webenv&quot;</span><span class="p">]</span>
                <span class="n">elink_payload</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;dbfrom&quot;</span><span class="p">:</span> <span class="s2">&quot;gds&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;db&quot;</span><span class="p">:</span> <span class="s2">&quot;sra&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;retmode&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;query_key&quot;</span><span class="p">:</span> <span class="n">query_key</span><span class="p">,</span>
                    <span class="s2">&quot;WebEnv&quot;</span><span class="p">:</span> <span class="n">web_env</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">requests_3_retries</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;https://eutils.ncbi.nlm.nih.gov/entrez/eutils/elink.fcgi&quot;</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="n">elink_payload</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">SEARCH_REQUEST_TIMEOUT</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                    <span class="n">uids_from_geo</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;linksets&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;linksetdbs&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;links&quot;</span><span class="p">]</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                    <span class="n">uids_from_geo</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># Step 2: Retrieve list of uids from SRA and</span>
                <span class="c1"># Find the intersection of both lists of uids</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_sra</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">requests_3_retries</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi&quot;</span><span class="p">,</span>
                        <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_request</span><span class="p">(),</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="n">SEARCH_REQUEST_TIMEOUT</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                    <span class="n">uids_from_sra</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;esearchresult&quot;</span><span class="p">][</span><span class="s2">&quot;idlist&quot;</span><span class="p">]</span>
                    <span class="n">uids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">uids_from_sra</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">uids_from_geo</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">uids</span> <span class="o">=</span> <span class="n">uids_from_geo</span>
                <span class="c1"># Ensure that only return_max number of uids are used</span>
                <span class="n">uids</span> <span class="o">=</span> <span class="n">uids</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_max</span><span class="p">]</span>
                <span class="c1"># Step 3: retrieves the detailed information for each uid</span>
                <span class="c1"># returned, in groups of SRA_SEARCH_GROUP_SIZE.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">uids</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;No results found for the following search query: </span><span class="se">\n</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;SRA: </span><span class="si">{self.fields}</span><span class="se">\n</span><span class="s2">GEO DataSets: </span><span class="si">{self.geo_fields}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span>  <span class="c1"># If no queries found, return nothing</span>
                <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">uids</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">uids</span><span class="p">),</span> <span class="n">SRA_SEARCH_GROUP_SIZE</span><span class="p">):</span>
                    <span class="n">current_uids</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">uids</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">SRA_SEARCH_GROUP_SIZE</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">uids</span><span class="p">))]</span>
                    <span class="p">)</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">SRA_SEARCH_GROUP_SIZE</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">uids</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span><span class="p">))</span>
                    <span class="n">payload2</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;db&quot;</span><span class="p">:</span> <span class="s2">&quot;sra&quot;</span><span class="p">,</span> <span class="s2">&quot;retmode&quot;</span><span class="p">:</span> <span class="s2">&quot;xml&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">current_uids</span><span class="p">}</span>

                    <span class="n">r</span> <span class="o">=</span> <span class="n">requests_3_retries</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi&quot;</span><span class="p">,</span>
                        <span class="n">params</span><span class="o">=</span><span class="n">payload2</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="n">SEARCH_REQUEST_TIMEOUT</span><span class="p">,</span>
                        <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode_content</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_format_response</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_format_result</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection to the server has timed out. Please retry.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;HTTPError: This is likely caused by an invalid search query: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">URL queried: </span><span class="si">{r.url}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">User query: </span><span class="si">{self.fields}</span><span class="s2">&quot;</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="GeoSearch.info"><a class="viewcode-back" href="../../pysradb.html#pysradb.search.GeoSearch.info">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Information on how to use GeoSearch.</span>

<span class="sd">        Displays information on how to query GEO DataSets / SRA via</span>
<span class="sd">        GeoSearch, including accepted inputs for geo_query,</span>
<span class="sd">        geo_dataset_type and geo_entry_type.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        info: str</span>
<span class="sd">            Information on how to use GeoSearch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;General Information:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;--------------------</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;GeoSearch (Or &#39;pysradb search --db geo ...&#39; on the command line) </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;is able to query both SRA and GEO DataSets, returning the subset </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;of entries that appears within both search queries. </span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Queries sent to SRA and GEO DataSets will have &#39;sra gds[Filter]&#39; </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;and &#39;gds sra[Filter]&#39; appended to the search queries respectively </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;to ensure that the entries in the search result can also be found </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;in the other API. </span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Queries sent to SRA uses the same fields as SraSearch, </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;or &#39;pysradb search --db sra ...&#39; on the command line. </span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;The following fields, if used, are sent as part of the GEO DataSets query: </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;organism, publication_date, geo_query, geo_dataset_type, geo_entry_type</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Notes about GEO DataSets specific fields: </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;----------------------------------------- </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;geo_query: This is the free text query, similar to &#39;query&#39;, that </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;is sent to GEO DataSets API. The &#39;query&#39; field is the free text </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;query sent to SRA API instead.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;geo_dataset_type: The type of GEO DataSet, which can be one of the following: </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  expression profiling by array </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  expression profiling by genome tiling array </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  expression profiling by high throughput sequencing </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  expression profiling by mpss </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  expression profiling by rt pcr </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  expression profiling by sage </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  expression profiling by snp array </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  genome binding/occupancy profiling by array </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  genome binding/occupancy profiling by genome tiling array </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  genome binding/occupancy profiling by high throughput sequencing </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  genome binding/occupancy profiling by snp array </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  genome variation profiling by array </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  genome variation profiling by genome tiling array </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  genome variation profiling by high throughput sequencing </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  genome variation profiling by snp array </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  methylation profiling by array </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  methylation profiling by genome tiling array </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  methylation profiling by high throughput sequencing </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  methylation profiling by snp array </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  non coding rna profiling by array </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  non coding rna profiling by genome tiling array </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  non coding rna profiling by high throughput sequencing </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  other </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  protein profiling by mass spec </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  protein profiling by protein array </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  snp genotyping by snp array </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  third party reanalysis</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;geo_dataset_type: The type of GEO entry, which can be one of the following: </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  gds</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  gpl</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  gse</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  gsm</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">info</span></div></div>
</pre></div>

              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2021, Saket Choudhary.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.2.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>